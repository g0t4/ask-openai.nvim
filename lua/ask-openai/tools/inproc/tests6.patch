*** Begin Patch
*** Add File: lua/ask-openai/tools/inproc/apply_patch_multi_tests.py
+import sys
+from io import StringIO
+from pathlib import Path
+import importlib.util
+import importlib.machinery
+
+import pytest
+
+
+@pytest.fixture(autouse=True)
+def mock_subprocess_run(monkeypatch):
+    """Patch subprocess.run to a dummy that records its arguments."""
+    import subprocess
+
+    calls: list[dict] = []
+
+    def dummy_run(cmd, input=None, text=None, check=None):  # noqa: D401
+        calls.append({"cmd": cmd, "input": input, "text": text, "check": check})
+        class Result:
+            returncode = 0
+        return Result()
+
+    monkeypatch.setattr(subprocess, "run", dummy_run)
+    return calls
+
+
+def load_module():
+    """Load the apply_patch_multi module from its source file."""
+    module_path = Path(__file__).parent / "apply_patch_multi.py"
+    loader = importlib.machinery.SourceFileLoader("apply_patch_multi", str(module_path))
+    spec = importlib.util.spec_from_loader(loader.name, loader)
+    mod = importlib.util.module_from_spec(spec)
+    loader.exec_module(mod)
+    return mod
+
+
+def test_de_dupe_end_patch(monkeypatch, capsys):
+    """Consecutive *** End Patch lines should collapse to a single line (dry‑run)."""
+    begin = "*" * 3 + " Begin Patch"
+    end = "*" * 3 + " End Patch"
+    content = f"{begin}\n+foo\n{end}\n{end}\n{end}\n"
+    monkeypatch.setattr(sys, "stdin", StringIO(content))
+    monkeypatch.setattr(sys, "argv", ["apply_patch_multi.py", "--dry-run"])
+
+    mod = load_module()
+    mod.main()
+
+    out = capsys.readouterr().out
+    assert out.count(end) == 2
+
+
+def test_multi_patch_split(monkeypatch, capsys, mock_subprocess_run):
+    """A file with multiple patches should be split and each applied separately (dry‑run)."""
+    begin = "*" * 3 + " Begin Patch"
+    end = "*" * 3 + " End Patch"
+    content = (
+        f"{begin}\n+foo\n{end}\n"
+        f"{begin}\n+bar\n{end}\n"
+    )
+    monkeypatch.setattr(sys, "stdin", StringIO(content))
+    monkeypatch.setattr(sys, "argv", ["apply_patch_multi.py", "--dry-run"])
+
+    mod = load_module()
+    mod.main()
+
+    out = capsys.readouterr().out
+    assert "Found 2 patch blocks" in out
+    assert "Applying patch #1:" in out
+    assert "Applying patch #2:" in out
+    assert mock_subprocess_run == []
+
*** End Patch
